steps:
  # ==========================================
  # 1. Build and Push Frontend
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-frontend', '.']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-frontend']

  # ==========================================
  # 2. Build and Push Backend
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-backend', './backend']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-backend']

  # ==========================================
  # 3. Build and Push Python Agent Service
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-python', './python-agent-service']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-python']

  # ==========================================
  # 4. Deploy Backend (NestJS)
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'ai-productivity-benchmark-backend'
      - '--image'
      - 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-backend'
      - '--region'
      - 'us-east1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--add-cloudsql-instances'
      - 'nice-opus-478203-b3:us-east1:ai-productivity-db'
      - '--port'
      - '3000'
      - '--set-env-vars'
      - 'DATABASE_URL=$_DATABASE_URL,GEMINI_API_KEY=$_GEMINI_API_KEY,JWT_SECRET=$_JWT_SECRET'

  # ==========================================
  # 5. Deploy Python Agent Service
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'ai-productivity-benchmark-python'
      - '--image'
      - 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-python'
      - '--region'
      - 'us-east1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--set-env-vars'
      - 'NESTJS_MCP_URL=https://ai-productivity-benchmark-backend-uc.a.run.app/api/mcp/sse,GEMINI_API_KEY=$_GEMINI_API_KEY'

  # ==========================================
  # 6. Deploy Frontend
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'ai-productivity-benchmark-frontend'
      - '--image'
      - 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-frontend'
      - '--region'
      - 'us-east1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'

images:
  - 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-frontend'
  - 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-backend'
  - 'gcr.io/$PROJECT_ID/ai-productivity-benchmark-python'

substitutions:
  _DATABASE_URL: ''
  _GEMINI_API_KEY: ''
  _JWT_SECRET: ''
